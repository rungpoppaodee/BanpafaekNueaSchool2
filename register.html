<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.js"></script>
  <style>
    body { font-family: 'Sarabun', sans-serif; text-align: center; padding: 20px; background: #f8f9fa; }
    video { border-radius: 8px; width: 100%; max-width: 500px; background: #000; transform: scaleX(-1); }
    .container { max-width: 600px; margin: 0 auto; }
    input { padding: 12px; width: 70%; font-size: 16px; margin-top: 15px; border: 1px solid #ddd; border-radius: 5px; }
    
    button { padding: 12px 25px; font-size: 16px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; margin-top: 15px; }
    button:disabled { background: #ccc; }
    
    #msg { margin-top: 15px; font-weight: bold; color: #28a745; min-height: 24px; }
    .instruction { font-size: 14px; color: #666; margin-bottom: 10px; }
    .count-badge { background: #6c757d; color: white; padding: 2px 8px; border-radius: 10px; font-size: 12px; margin-left: 5px;}
  </style>
</head>
<body>
  <div class="container">
    <h2>üë§ ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤</h2>
    <p class="instruction">üí° ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥ ‡∏Ñ‡∏ß‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å 3 ‡∏°‡∏∏‡∏° (‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏£‡∏á / ‡∏´‡∏±‡∏ô‡∏ã‡πâ‡∏≤‡∏¢‡∏ô‡∏¥‡∏î‡∏´‡∏ô‡πà‡∏≠‡∏¢ / ‡∏´‡∏±‡∏ô‡∏Ç‡∏ß‡∏≤‡∏ô‡∏¥‡∏î‡∏´‡∏ô‡πà‡∏≠‡∏¢)</p>
    
    <div id="status">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î Model...</div>
    <video id="video" autoplay muted playsinline></video>
    
    <input type="text" id="username" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (‡πÄ‡∏ä‡πà‡∏ô Admin)">
    <br>
    <button id="btnSave" onclick="saveFace()" disabled>üì∏ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤ <span id="saveCount" class="count-badge">0</span></button>
    
    <div id="msg"></div>
    
    <? var url = getScriptUrl(); ?>
    <a href="<?= url ?>" style="display:block; margin-top:20px; color:#666;">‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏°‡∏ô‡∏π</a>
  </div>

  <script>
    const video = document.getElementById('video');
    const status = document.getElementById('status');
    const btnSave = document.getElementById('btnSave');
    const msgDiv = document.getElementById('msg');
    const saveCountSpan = document.getElementById('saveCount');
    let saveCounter = 0;

    window.addEventListener('load', async () => {
      await Promise.all([
        faceapi.nets.ssdMobilenetv1.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models'),
        faceapi.nets.faceLandmark68Net.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models'),
        faceapi.nets.faceRecognitionNet.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models')
      ]);
      startVideo();
    });

    function startVideo() {
      navigator.mediaDevices.getUserMedia({ video: {} })
        .then(stream => {
          video.srcObject = stream;
          status.innerText = "";
          btnSave.disabled = false;
        });
    }

    async function saveFace() {
      const name = document.getElementById('username').value.trim();
      if (!name) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡πà‡∏≠‡∏ô");

      btnSave.disabled = true;
      btnSave.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...";
      msgDiv.innerText = "";

      const detection = await faceapi.detectSingleFace(video).withFaceLandmarks().withFaceDescriptor();

      if (detection) {
        const descriptorArray = Array.from(detection.descriptor);
        
        google.script.run.withSuccessHandler(() => {
          saveCounter++;
          saveCountSpan.innerText = saveCounter;
          
          msgDiv.innerText = `‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà ${saveCounter} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏•‡∏≠‡∏á‡∏Ç‡∏¢‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á`;
          
          btnSave.disabled = false;
          btnSave.innerText = `üì∏ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°`;
          
          // ‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ä‡∏∑‡πà‡∏≠ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Å‡∏î‡∏ã‡πâ‡∏≥‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢
        }).registerUser(name, descriptorArray);
        
      } else {
        alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏°‡∏≠‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÉ‡∏´‡πâ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô");
        btnSave.disabled = false;
        btnSave.innerText = "üì∏ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤";
      }
    }
  </script>
</body>
</html>
