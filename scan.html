<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.js"></script>
  <style>
    body { font-family: 'Sarabun', sans-serif; text-align: center; padding: 20px; background-color: #f0f2f5; }
    
    .video-container { position: relative; width: 100%; max-width: 600px; margin: 20px auto; border-radius: 12px; overflow: hidden; background: #000; min-height: 350px; }
    video { width: 100%; height: auto; display: block; transform: scaleX(-1); opacity: 0; transition: opacity 0.5s; }
    video.active { opacity: 1; }
    
    #overlay-status { position: absolute; top: 15px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.7); color: white; padding: 8px 20px; border-radius: 30px; z-index: 10; white-space: nowrap; }
    
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 100; align-items: center; justify-content: center; }
    
    /* ‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á Modal ‡πÉ‡∏´‡πâ‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°‡πÅ‡∏•‡∏∞‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏´‡∏ç‡πà */
    .modal-content { 
      background: white; 
      padding: 30px; 
      border-radius: 20px; 
      width: 85%; 
      max-width: 350px; 
      text-align: center; 
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    
    /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà ‡πÄ‡∏ï‡πá‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á */
    .btn { border: none; border-radius: 12px; cursor: pointer; margin: 5px 0; width: 100%; color: white; font-family: 'Sarabun', sans-serif; transition: transform 0.1s; }
    .btn:active { transform: scale(0.98); }

    /* ‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô (‡πÉ‡∏´‡∏ç‡πà‡πÅ‡∏•‡∏∞‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏ô) */
    .btn-confirm { 
      background: linear-gradient(135deg, #28a745 0%, #218838 100%); 
      padding: 18px; 
      font-size: 22px; 
      font-weight: bold; 
      box-shadow: 0 4px 10px rgba(40, 167, 69, 0.3);
      margin-bottom: 10px;
    } 
    
    /* ‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å (‡πÄ‡∏•‡πá‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡πÅ‡∏•‡∏∞‡∏≠‡∏¢‡∏π‡πà‡∏•‡πà‡∏≤‡∏á) */
    .btn-cancel { 
      background: #dc3545; 
      padding: 12px; 
      font-size: 16px; 
      background: #f8d7da;
      color: #721c24;
      font-weight: 600;
    }
    
    /* ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡πÅ‡∏Å‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å */
    .btn-start {
      background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
      padding: 15px 30px;
      font-size: 20px;
      font-weight: bold;
      color: white;
      border: none;
      border-radius: 50px;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(0, 123, 255, 0.4);
      margin: 20px auto;
      display: none; /* ‡∏ã‡πà‡∏≠‡∏ô‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô */
      width: auto;
      min-width: 200px;
    }
    .btn-start:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0, 123, 255, 0.5); }

    .user-name { font-size: 28px; color: #007bff; font-weight: bold; margin: 5px 0; }
    .score-text { color:#888; font-size:14px; margin-bottom:20px; }
    
    /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏ß‡∏•‡∏≤ */
    .time-badge {
      background-color: #e9ecef;
      color: #333;
      padding: 8px 20px;
      border-radius: 30px;
      font-size: 18px;
      font-weight: 600;
      margin: 10px 0;
      display: inline-block;
    }

    .gps-alert { color: #dc3545; font-weight: bold; margin-top: 10px; display: none; padding: 10px; border: 1px solid #dc3545; border-radius: 5px; background: #fff5f5; }
  </style>
</head>
<body>
  <h2>üì∑ ‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô</h2>
  <div id="main-status">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏£‡∏∞‡∏ö‡∏ö...</div>
  <div id="gps-status" style="font-size: 0.9em; color: #666; margin-bottom: 10px;"></div>

  <div id="gps-alert-box" class="gps-alert">
    ‚ö†Ô∏è ‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏¢‡∏π‡πà‡∏ô‡∏≠‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î!<br>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏Å‡∏•‡πâ‡∏à‡∏∏‡∏î‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
  </div>

  <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡πÅ‡∏Å‡∏ô -->
  <button id="btnStart" class="btn-start" onclick="startVideo()">üì∑ ‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡πÅ‡∏Å‡∏ô</button>

  <div class="video-container">
    <div id="overlay-status">‡∏£‡∏≠‡πÇ‡∏´‡∏•‡∏î...</div>
    <video id="video" autoplay muted playsinline></video>
  </div>
  
  <? var url = getScriptUrl(); ?>
  <a href="<?= url ?>" style="margin-top:20px; display:inline-block; text-decoration:none; color:#555;">‚Üê ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å / ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å</a>

  <div id="confirmModal" class="modal-overlay">
    <div class="modal-content">
      <h3 style="margin:0; color:#555;">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô</h3>
      
      <!-- ‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô -->
      <div class="user-name" id="modalName">...</div>
      
      <!-- ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏ß‡∏•‡∏≤ -->
      <div id="modalTime" class="time-badge">00:00</div>
      
      <!-- ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô -->
      <div id="modalScore" class="score-text"></div>
      
      <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô (‡πÉ‡∏´‡∏ç‡πà) -->
      <button class="btn btn-confirm" onclick="confirmAttendance()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
      
      <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å (‡πÄ‡∏•‡πá‡∏Å) -->
      <button class="btn btn-cancel" onclick="cancelAttendance()">‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà</button>
    </div>
  </div>

  <script>
    const video = document.getElementById('video');
    const mainStatus = document.getElementById('main-status');
    const overlayStatus = document.getElementById('overlay-status');
    const confirmModal = document.getElementById('confirmModal');
    const gpsStatus = document.getElementById('gps-status');
    const gpsAlertBox = document.getElementById('gps-alert-box');
    const btnStart = document.getElementById('btnStart');
    
    const MAIN_MENU_URL = "<?= url ?>"; 
    let knownFaces = [];
    let scanInterval = null;
    let currentMatch = null;
    const MATCH_THRESHOLD = 0.45; 

    // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏Å‡πá‡∏ö‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
    let currentLat = null;
    let currentLng = null;

    window.addEventListener('load', async () => {
      try {
        mainStatus.innerText = "1/4 Checking GPS...";
        await checkGPS();
      } catch(e) { showError(e.message); }
    });

    function checkGPS() {
      return new Promise((resolve, reject) => {
        if (!navigator.geolocation) {
          reject(new Error("Browser ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö GPS"));
          return;
        }

        navigator.geolocation.getCurrentPosition(
          async (position) => {
            currentLat = position.coords.latitude;
            currentLng = position.coords.longitude;
            
            google.script.run.withSuccessHandler(config => {
              if (!config.lat || !config.lng || config.radius == 0) {
                 gpsStatus.innerText = "üìç GPS: ‡πÑ‡∏°‡πà‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà";
                 resolve();
                 initFaceSystem(); 
                 return;
              }

              const dist = getDistanceFromLatLonInKm(currentLat, currentLng, config.lat, config.lng);
              
              if (dist <= config.radius) {
                gpsStatus.innerText = `üìç GPS: OK (‡∏´‡πà‡∏≤‡∏á‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ ${dist.toFixed(3)} km)`;
                gpsStatus.style.color = "green";
                resolve();
                initFaceSystem();
              } else {
                gpsStatus.innerText = `üìç GPS: ‡∏´‡πà‡∏≤‡∏á‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ (${dist.toFixed(3)} km / ‡∏Å‡∏≥‡∏´‡∏ô‡∏î ${config.radius} km)`;
                gpsStatus.style.color = "red";
                gpsAlertBox.style.display = "block";
                mainStatus.innerText = "‚õî ‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡∏™‡πÅ‡∏Å‡∏ô";
                overlayStatus.innerText = "Out of Range";
              }
            }).getConfig();
          },
          (err) => reject(new Error("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î GPS (Location Service)"))
        );
      });
    }

    async function initFaceSystem() {
      mainStatus.innerText = "2/4 Loading AI...";
      if(typeof faceapi === 'undefined') throw new Error("Library Load Failed");
      
      const MODEL_URL = 'https://justadudewhohacks.github.io/face-api.js/models';
      await Promise.all([
        faceapi.nets.ssdMobilenetv1.loadFromUri(MODEL_URL),
        faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
        faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)
      ]);
      
      loadFaceData();
    }

    function loadFaceData() {
      mainStatus.innerText = "3/4 Loading Database...";
      google.script.run.withSuccessHandler(data => {
        if(!data || data.length === 0) return showError("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô");
        
        knownFaces = data.map(u => ({
          name: u.label,
          descriptor: new Float32Array(u.descriptor)
        }));
        
        // --- ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ: ‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏Å startVideo() ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ---
        mainStatus.innerText = "‚úÖ ‡∏£‡∏∞‡∏ö‡∏ö‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô";
        mainStatus.style.color = "green";
        
        // ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡πÅ‡∏Å‡∏ô
        btnStart.style.display = "inline-block";
        
      }).getKnownFaces();
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°
    function startVideo() {
      btnStart.style.display = "none"; // ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°
      mainStatus.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á...";
      mainStatus.style.color = "black";

      navigator.mediaDevices.getUserMedia({ video: {} }).then(stream => {
        video.srcObject = stream;
        video.classList.add('active'); 
        mainStatus.innerText = "‚úÖ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πÅ‡∏Å‡∏ô...";
        mainStatus.style.color = "green";
        startScanningLoop();
      }).catch(err => {
         showError("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ: " + err.message);
         btnStart.style.display = "inline-block"; // ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏´‡∏°‡πà‡∏ñ‡πâ‡∏≤‡∏û‡∏•‡∏≤‡∏î
      });
    }

    function startScanningLoop() {
      if (scanInterval) clearInterval(scanInterval);
      overlayStatus.innerText = "‡∏°‡∏≠‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πÅ‡∏Å‡∏ô";
      overlayStatus.style.background = "rgba(0,0,0,0.7)";
      
      scanInterval = setInterval(async () => {
        if (video.paused || video.ended) return;
        
        const detection = await faceapi.detectSingleFace(video).withFaceLandmarks().withFaceDescriptor();
        
        if (detection) {
          const bestMatch = findBestMatch(detection.descriptor);
          
          if (bestMatch.distance < MATCH_THRESHOLD) {
            clearInterval(scanInterval);
            showModal(bestMatch);
          } else {
            overlayStatus.innerText = `‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ‡∏à‡∏±‡∏Å (${bestMatch.distance.toFixed(2)})`;
            overlayStatus.style.background = "rgba(200, 0, 0, 0.7)";
          }
        }
      }, 500);
    }

    function findBestMatch(queryDescriptor) {
      let bestMatch = { name: 'unknown', distance: 1.0 };
      knownFaces.forEach(user => {
        const distance = faceapi.euclideanDistance(queryDescriptor, user.descriptor);
        if (distance < bestMatch.distance) {
          bestMatch = { name: user.name, distance: distance };
        }
      });
      return bestMatch;
    }

    function showModal(match) {
      currentMatch = match.name;
      
      // ‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠
      document.getElementById('modalName').innerText = match.name;
      
      // ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
      const now = new Date();
      const timeStr = now.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });
      document.getElementById('modalTime').innerText = `‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô: ${timeStr} ‡∏ô.`;

      // ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô
      document.getElementById('modalScore').innerText = `‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô: ${(1-match.distance).toFixed(2)*100}%`;
      
      confirmModal.style.display = "flex";
      mainStatus.innerText = "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô...";
    }

    function confirmAttendance() {
      const btn = document.querySelector('.btn-confirm');
      btn.disabled = true;
      btn.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...";
      
      google.script.run.withSuccessHandler(() => {
        alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
        window.top.location.href = MAIN_MENU_URL;
      }).logAttendance(currentMatch, currentLat, currentLng);
    }

    function cancelAttendance() {
      // 1. ‡∏õ‡∏¥‡∏î Modal
      confirmModal.style.display = "none";
      currentMatch = null;
      
      // 2. ‡∏´‡∏¢‡∏∏‡∏î Loop Scan
      if (scanInterval) clearInterval(scanInterval);

      // 3. ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á (Stop Camera Stream)
      if (video.srcObject) {
        const stream = video.srcObject;
        const tracks = stream.getTracks();
        tracks.forEach(track => track.stop());
        video.srcObject = null;
      }
      video.classList.remove('active'); // ‡∏ã‡πà‡∏≠‡∏ô‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠ (Fade out)

      // 4. ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° UI
      mainStatus.innerText = "‚úÖ ‡∏£‡∏∞‡∏ö‡∏ö‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô";
      mainStatus.style.color = "green";
      overlayStatus.innerText = "‡∏£‡∏≠‡πÇ‡∏´‡∏•‡∏î...";
      
      // 5. ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡πÅ‡∏Å‡∏ô‡πÉ‡∏´‡∏°‡πà
      btnStart.style.display = "inline-block";
    }

    function showError(msg) { mainStatus.innerHTML = `<span style='color:red'>‚ùå ${msg}</span>`; }

    function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
      var R = 6371; 
      var dLat = deg2rad(lat2-lat1); 
      var dLon = deg2rad(lon2-lon1); 
      var a = 
        Math.sin(dLat/2) * Math.sin(dLat/2) +
        Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * Math.sin(dLon/2) * Math.sin(dLon/2); 
      var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
      var d = R * c; 
      return d;
    }

    function deg2rad(deg) {
      return deg * (Math.PI/180)
    }
  </script>
</body>
</html>
